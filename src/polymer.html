<!--
  Web components for options page
  @author Sven Ackermann (svenrecknagel@gmail.com)
  @license BSD license
-->
<link rel="import" href="../node_modules/npm-polymer-elements/polymer/polymer.html"/>
<link rel="import" href="../node_modules/npm-polymer-elements/paper-input/paper-input.html"/>
<link rel="import" href="../node_modules/npm-polymer-elements/paper-dropdown-menu/paper-dropdown-menu.html"/>
<link rel="import" href="../node_modules/npm-polymer-elements/paper-listbox/paper-listbox.html"/>
<link rel="import" href="../node_modules/npm-polymer-elements/paper-item/paper-item.html"/>
<link rel="import" href="../node_modules/npm-polymer-elements/paper-toggle-button/paper-toggle-button.html"/>

<dom-module id="pp-numberinput">
  <template>
    <style>
      :host {
        display: block;
      }
      #input {  
        min-height: initial;
      }
    </style>
    <paper-input
      id="input"
      type="number"
      min="[[min]]"
      max="[[max]]"
      step="[[step]]"
      label="[[i18nlabel(id)]]"
    ></paper-input>
  </template>
</dom-module>

<dom-module id="pp-select">
  <template>
    <style>
      :host {
        display: block;
      }
      paper-dropdown-menu {
        width: 100%;
      }
    </style>
    <paper-dropdown-menu label="[[i18nlabel(id)]]">
      <paper-listbox id="input" class="dropdown-content" attr-for-selected="value">
      </paper-listbox>
    </paper-dropdown-menu>
  </template>
</dom-module>

<dom-module id="pp-toggle">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <paper-toggle-button id="input">[[i18nlabel(id)]]</paper-toggle-button>
  </template>
</dom-module>

<script>
  /* global chrome, Polymer */
  /* jshint jquery: true */
  var PpInputBehavior = {
    properties: {
      local: Boolean,
      hint: Boolean
    },
    i18nlabel: function(id) {
      return chrome.i18n.getMessage("setting_" + id);
    },
    listeners: {
      settingsready: "_onSettingsReady"
    },
    ready: function() {
      this.toggleClass("pp-input", true);
    },
    getSettings: function(e) {
      return this.local ? e.localSettings : e.settings;
    }
  };

  Polymer({
    is: "pp-numberinput",
    behaviors: [PpInputBehavior],
    _onSettingsReady: function(e) {
      var settings = this.getSettings(e);
      var prop = this.id;
      var input = this.$.input;
      settings.w(prop, function(val) { input.value = val; }, e.context);
      $(input).on("blur", function() {
        var value = parseFloat(input.value);
        if ($.isNumeric(input.min) && value < input.min || $.isNumeric(input.max) && value > input.max) input.value = settings[prop];
        else settings[prop] = value;
      });
    }
  });
  
  Polymer({
    is: "pp-select",
    behaviors: [PpInputBehavior],
    properties: {
      options: {
        type: String,
        value: ""
      },
      type: {
        type: String,
        value: "s"
      },
      getoptionstext: {
        type: String,
        value: "bundle"
      },
      from: String
    },
    _safeValue: function(val) {
      return val === "" ? "_" : val === 0 ? "_0" : val;
    },
    _onSettingsReady: function(e) {
      var settings = this.settings = this.getSettings(e);
      var prop = this.id;
      var config = this.from ? $(this.from)[0] : this;
      var type = this.type;
      var options = config.options.split(",");
      var getOptionText = e.optionsTextGetter[config.getoptionstext];
      var listbox = this.$.input;
      var items = [];
      options.forEach(function(option) {
        var optionClass;
        if (option.indexOf(":") >= 0) {
          var split = option.split(":");
          option = split[0];
          optionClass = split[1];
        }
        var item = { clazz: optionClass, text: getOptionText(option, prop), value: type == "n" ? parseFloat(option) : option };
        items.push(item);
      });
      this.setItems(items);
      var safeValue = this._safeValue;
      settings.al(prop, function(val) { listbox.select(safeValue(val)); }, e.context);
      $(listbox).on("iron-select", function() {
        var val = listbox.selected;
        settings[prop] = val == "_" ? "" : val == "_0" ? 0 : val;
      });
    },
    setItems: function(items) {
      var listbox = this.$.input;
      var safeValue = this._safeValue;
      $(listbox).empty();
      items.forEach(function(item) {
        var pItem = $("<paper-item>").addClass(item.clazz || "").text(item.text)[0];
        var val = item.value;
        pItem.value = safeValue(val);
        Polymer.dom(listbox).appendChild(pItem);
      });
      var val = this.settings[this.id];
      listbox.select(safeValue(val));
    }
  });

  Polymer({
    is: "pp-toggle",
    behaviors: [PpInputBehavior],
    _onSettingsReady: function(e) {
      var settings = this.getSettings(e);
      var prop = this.id;
      var input = this.$.input;
      settings.w(prop, function(val) { input.checked = val; }, e.context);
      $(input).on("change", function() { settings[prop] = input.checked; });
    }
  });
</script>
