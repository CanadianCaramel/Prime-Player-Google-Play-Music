<!--
  Web components for options page
  @author Sven Ackermann (svenrecknagel@gmail.com)
  @license BSD license
-->
<link rel="import" href="../node_modules/npm-polymer-elements/polymer/polymer.html"/>
<link rel="import" href="../node_modules/npm-polymer-elements/paper-input/paper-input.html"/>
<link rel="import" href="../node_modules/npm-polymer-elements/paper-dropdown-menu/paper-dropdown-menu.html"/>
<link rel="import" href="../node_modules/npm-polymer-elements/paper-listbox/paper-listbox.html"/>
<link rel="import" href="../node_modules/npm-polymer-elements/paper-item/paper-item.html"/>
<link rel="import" href="../node_modules/npm-polymer-elements/paper-toggle-button/paper-toggle-button.html"/>
<link rel="import" href="../node_modules/npm-polymer-elements/paper-slider/paper-slider.html"/>
<link rel="import" href="../node_modules/npm-polymer-elements/paper-icon-button/paper-icon-button.html"/>
<link rel="import" href="../node_modules/npm-polymer-elements/paper-dialog/paper-dialog.html"/>
<link rel="import" href="../node_modules/npm-polymer-elements/paper-button/paper-button.html"/>

<dom-module id="pp-input">
  <template>
    <style>
      :host {
        display: block;
      }
      #input {  
        min-height: initial;
      }
    </style>
    <paper-input
      id="input"
      type="[[type]]"
      min="[[min]]"
      max="[[max]]"
      step="[[step]]"
      label="[[i18nlabel(id)]]"
      value="{{value}}"
    ></paper-input>
  </template>
</dom-module>

<dom-module id="pp-select">
  <template>
    <style>
      :host {
        display: block;
      }
      paper-dropdown-menu {
        width: 100%;
      }
      paper-listbox {
        overflow-x: auto;
      }
      paper-item {
        min-width: 200px;
      }
    </style>
    <paper-dropdown-menu label="[[i18nlabel(id)]]" no-animations>
      <paper-listbox id="input" class="dropdown-content" attr-for-selected="value">
        <template is="dom-repeat" items="[[items]]" as="item">
          <paper-item class$="[[item.clazz]]" value="_[[item.value]]">[[item.text]]</paper-item>
        </template>
      </paper-listbox>
    </paper-dropdown-menu>
  </template>
</dom-module>

<dom-module id="pp-toggle">
  <template>
    <style>
      :host {
        display: block;
        --paper-toggle-button-label-color: var(--secondary-text-color);
      }
      paper-toggle-button {
        display: inline-flex;
      }
      label {
        color: var(--secondary-text-color);
      }
    </style>
    <paper-toggle-button id="input">[[i18nlabel(id)]]</paper-toggle-button>
    <label></label>
  </template>
</dom-module>

<dom-module id="pp-slider">
  <template>
    <style>
      :host {
        display: block;
        --paper-input-container-underline: {
          display: none;
        };
        --paper-input-container-underline-focus: {
          display: none;
        };
      }
    </style>
    <paper-input-container>
      <label>[[i18nlabel(id)]]</label>
      <paper-slider
        class="paper-input-input"
        id="input"
        min$="[[min]]"
        max$="[[max]]"
        step$="[[step]]"
        value="{{value}}"
        pin
        editable
      ></paper-slider>
    </paper-input-container>
  </template>
</dom-module>

<dom-module id="pp-iconchoice">
  <template>
    <style>
      :host {
        display: block;
        --paper-input-container-underline: {
          display: none;
        };
        --paper-input-container-underline-focus: {
          display: none;
        };
      }
      paper-icon-button[active] {
        outline: 1px auto black;
      }
    </style>
    <paper-input-container always-float-label>
      <label>[[i18nlabel(id)]]</label>
      <div class="paper-input-input" id="input">
        <template is="dom-repeat" items="[[items]]" as="item">
          <paper-icon-button value$="[[item]]" src="img/icon/[[item]]/connected.png" toggles mini on-tap="_tapped"></paper-icon-button>
        </template>
      </div>
    </paper-input-container>
  </template>
</dom-module>

<script>
  /* global chrome, Polymer */
  /* jshint jquery: true */
  var i18n = chrome.i18n.getMessage;
  var PpInputBehavior = {
    properties: {
      local: Boolean,
      hint: Boolean,
      id: String,
      value: {
        notify: true
      }
    },
    i18nlabel: function(id) {
      return i18n("setting_" + id);
    },
    ready: function() {
      this.toggleClass("pp-optioninput", true);
      if (this.hint) {
        var dialog = $("<paper-dialog>");
        $("<h2>").text(this.i18nlabel(this.id)).appendTo(dialog);
        $("<p>").html(i18n("setting_" + this.id + "Hint")).appendTo(dialog);
        var buttons = $("<div class='buttons'>");
        $("<paper-button dialog-confirm>").text("OK").appendTo(buttons);
        dialog.append(buttons);
        $(this).append(dialog);
        dialog = dialog[0];
        $("<paper-icon-button icon='help-outline' class='hint-trigger' noink mini>")
          .on("tap", function() {
            dialog.open();
            return false;
          })
          .appendTo($("label", this));
      }
    }
  };

  Polymer({
    is: "pp-input",
    behaviors: [PpInputBehavior],
    properties: {
      type: {
        type: String,
        value: "number"
      },
    }
  });
  
  Polymer({
    is: "pp-select",
    behaviors: [PpInputBehavior],
    properties: {
      options: {
        type: String,
        value: ""
      },
      type: {
        type: String,
        value: "text"
      },
      getoptionstext: {
        type: String,
        value: "bundle"
      },
      from: String,
      items: {
        type: Array,
        value: []
      }
    },
    ready: function() {
      var that = this;
      var input = this.$.input;
      $(input).on("iron-select", function() { that.value = input.selected.substr(1); });
      //prefix value with "_", because listbox's attrForSelected does not work correctly with empty string or 0
      this.addEventListener("value-changed", function(e) { input.select("_" + e.detail.value); });
    }
  });

  Polymer({
    is: "pp-toggle",
    behaviors: [PpInputBehavior],
    ready: function() {
      var that = this;
      var input = this.$.input;
      $(input).on("change", function() { that.value = input.checked; });
      this.addEventListener("value-changed", function(e) { input.checked = e.detail.value; });
    }
  });

  Polymer({
    is: "pp-slider",
    behaviors: [PpInputBehavior, Polymer.PaperInputBehavior]
  });

  Polymer({
    is: "pp-iconchoice",
    behaviors: [PpInputBehavior, Polymer.PaperInputBehavior],
    properties: {
      items: {
        type: Array,
        value: []
      }
    },
    _applyValue: function(val) {
      $("paper-icon-button[value!='" + val + "']", this).removeAttr("active");
      $("paper-icon-button[value='" + val + "']", this)[0].active = true;
    },
    ready: function() {
      var that = this;
      this.addEventListener("value-changed", function(e) { that._applyValue(e.detail.value); });
    },
    _tapped: function(e) {
      var val = $(e.target).closest("paper-icon-button")[0].value;
      this._applyValue(val);
      this.value = val;
    }
  });
</script>
