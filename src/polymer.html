<!--
  Web components for options page
  @author Sven Ackermann (svenrecknagel@gmail.com)
  @license BSD license
-->
<link rel="import" href="../node_modules/npm-polymer-elements/polymer/polymer.html"/>
<link rel="import" href="../node_modules/npm-polymer-elements/paper-input/paper-input.html"/>
<link rel="import" href="../node_modules/npm-polymer-elements/paper-dropdown-menu/paper-dropdown-menu.html"/>
<link rel="import" href="../node_modules/npm-polymer-elements/paper-listbox/paper-listbox.html"/>
<link rel="import" href="../node_modules/npm-polymer-elements/paper-item/paper-item.html"/>
<link rel="import" href="../node_modules/npm-polymer-elements/paper-toggle-button/paper-toggle-button.html"/>
<link rel="import" href="../node_modules/npm-polymer-elements/paper-slider/paper-slider.html"/>
<link rel="import" href="../node_modules/npm-polymer-elements/paper-icon-button/paper-icon-button.html"/>

<dom-module id="pp-input">
  <template>
    <style>
      :host {
        display: block;
      }
      #input {  
        min-height: initial;
      }
    </style>
    <paper-input
      id="input"
      type="[[type]]"
      min="[[min]]"
      max="[[max]]"
      step="[[step]]"
      label="[[i18nlabel(id)]]"
    ></paper-input>
  </template>
</dom-module>

<dom-module id="pp-select">
  <template>
    <style>
      :host {
        display: block;
      }
      paper-dropdown-menu {
        width: 100%;
      }
    </style>
    <paper-dropdown-menu label="[[i18nlabel(id)]]">
      <paper-listbox id="input" class="dropdown-content" attr-for-selected="value">
        <template is="dom-repeat" items="[[items]]" as="item">
          <paper-item class$="[[item.clazz]]" value="_[[item.value]]">[[item.text]]</paper-item>
        </template>
      </paper-listbox>
    </paper-dropdown-menu>
  </template>
</dom-module>

<dom-module id="pp-toggle">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <paper-toggle-button id="input">[[i18nlabel(id)]]</paper-toggle-button>
  </template>
</dom-module>

<dom-module id="pp-slider">
  <template>
    <style>
      :host {
        display: block;
        --paper-input-container-underline: {
          display: none;
        };
        --paper-input-container-underline-focus: {
          display: none;
        };
      }
    </style>
    <paper-input-container>
      <label>[[i18nlabel(id)]]</label>
      <paper-slider
        class="paper-input-input"
        id="input"
        min$="[[min]]"
        max$="[[max]]"
        step$="[[step]]"
        pin
        editable
      ></paper-slider>
    </paper-input-container>
  </template>
</dom-module>

<dom-module id="pp-iconchoice">
  <template>
    <style>
      :host {
        display: block;
        --paper-input-container-underline: {
          display: none;
        };
        --paper-input-container-underline-focus: {
          display: none;
        };
      }
      paper-icon-button[active] {
        outline: 1px auto black;
      }
    </style>
    <paper-input-container always-float-label>
      <label>[[i18nlabel(id)]]</label>
      <div class="paper-input-input" id="input">
        <template is="dom-repeat" items="[[items]]" as="item">
          <paper-icon-button value$="[[item]]" src="img/icon/[[item]]/connected.png" toggles mini on-tap="_tapped"></paper-icon-button>
        </template>
      </div>
    </paper-input-container>
  </template>
</dom-module>

<script>
  /* global chrome, Polymer */
  /* jshint jquery: true */
  var PpInputBehavior = {
    properties: {
      local: Boolean,
      hint: Boolean
    },
    i18nlabel: function(id) {
      return chrome.i18n.getMessage("setting_" + id);
    },
    listeners: {
      settingsready: "_onSettingsReady"
    },
    ready: function() {
      this.toggleClass("pp-input", true);
    },
    getSettings: function(e) {
      return this.local ? e.localSettings : e.settings;
    }
  };

  Polymer({
    is: "pp-input",
    behaviors: [PpInputBehavior],
    properties: {
      type: {
        type: String,
        value: "number"
      },
    },
    _onSettingsReady: function(e) {
      var settings = this.getSettings(e);
      var prop = this.id;
      var input = this.$.input;
      var numeric = this.type == "number";
      settings.w(prop, function(val) { input.value = val; }, e.context);
      $(input).on("change", function() {
        if (numeric) {
          var value = parseFloat(input.value);
          if ($.isNumeric(input.min) && value < input.min || $.isNumeric(input.max) && value > input.max) input.value = settings[prop];
          else settings[prop] = value;
        } else settings[prop] = input.value;
      });
    }
  });
  
  Polymer({
    is: "pp-select",
    behaviors: [PpInputBehavior],
    properties: {
      options: {
        type: String,
        value: ""
      },
      type: {
        type: String,
        value: "s"
      },
      getoptionstext: {
        type: String,
        value: "bundle"
      },
      from: String,
      items: {
        type: Array,
        value: []
      }
    },
    _onSettingsReady: function(e) {
      var settings = this.settings = this.getSettings(e);
      var prop = this.id;
      var config = this.from ? $(this.from)[0] : this;
      var type = this.type;
      var options = config.options.split(",");
      var getOptionText = e.optionsTextGetter[config.getoptionstext];
      var listbox = this.$.input;
      var items = [];
      options.forEach(function(option) {
        var optionClass = "";
        if (option.indexOf(":") >= 0) {
          var split = option.split(":");
          option = split[0];
          optionClass = split[1];
        }
        var item = { clazz: optionClass, text: getOptionText(option, prop), value: option };
        items.push(item);
      });
      this.items = items;
      //prefix value with "_", because listbox's attrForSelected does not work correctly with empty string or 0
      settings.w(prop, function(val) { listbox.select("_" + val); }, e.context);
      $(listbox).on("iron-select", function() {
        var val = listbox.selected.substr(1);
        settings[prop] = type == "n" ? parseFloat(val) : val;
      });
    }
  });

  Polymer({
    is: "pp-toggle",
    behaviors: [PpInputBehavior],
    _onSettingsReady: function(e) {
      var settings = this.getSettings(e);
      var prop = this.id;
      var input = this.$.input;
      settings.w(prop, function(val) { input.checked = val; }, e.context);
      $(input).on("change", function() { settings[prop] = input.checked; });
    }
  });

  Polymer({
    is: "pp-slider",
    behaviors: [PpInputBehavior, Polymer.PaperInputBehavior],
    _onSettingsReady: function(e) {
      var settings = this.getSettings(e);
      var prop = this.id;
      var input = this.$.input;
      settings.w(prop, function(val) { input.value = val; }, e.context);
      $(input).on("change", function() { settings[prop] = input.value; });
    }
  });

  Polymer({
    is: "pp-iconchoice",
    behaviors: [PpInputBehavior, Polymer.PaperInputBehavior],
    properties: {
      items: {
        type: Array,
        value: []
      }
    },
    _applyValue: function(val) {
      $("paper-icon-button[value!='" + val + "']", input).removeAttr("active");
      $("paper-icon-button[value='" + val + "']", input)[0].active = true;
    },
    _onSettingsReady: function(e) {
      this.settings = this.getSettings(e);
      var prop = this.id;
      var input = this;
      this.settings.w(prop, function(val) {
        input._applyValue(val);
      }, e.context);
    },
    _tapped: function(e) {
      var val = $(e.target).closest("paper-icon-button")[0].value;
      this._applyValue(val);
      this.settings[this.id] = val;
    }
  });
</script>
